# frozen_string_literal: true

require_relative "../enum"
require_relative "../pattern"
require_relative "../schema_object"

# Vulnerability - Defines a weakness in a component or service that could be exploited or triggered by a threat source.
module SBOM
  module CycloneDX
    class Vulnerability < Struct.new(
      "Vulnerability",
      # BOM Reference - An optional identifier which can be used to reference the vulnerability elsewhere in the BOM. Every bom-ref must be unique within the BOM. Value SHOULD not start with the BOM-Link intro 'urn:cdx:' to avoid conflicts with BOM-Links.
      :bom_ref,
      # ID - The identifier that uniquely identifies the vulnerability.
      # Examples: "CVE-2021-39182", "GHSA-35m5-8cvj-8783", "SNYK-PYTHON-ENROCRYPT-1912876"
      :id,
      # The source that published the vulnerability.
      :source,
      # References - Zero or more pointers to vulnerabilities that are the equivalent of the vulnerability specified. Often times, the same vulnerability may exist in multiple sources of vulnerability intelligence, but have different identifiers. References provide a way to correlate vulnerabilities across multiple sources of vulnerability intelligence.
      :references,
      # Ratings - List of vulnerability ratings
      :ratings,
      # CWEs - List of Common Weaknesses Enumerations (CWEs) codes that describes this vulnerability.
      # Contains integer representations of Common Weaknesses Enumerations (CWE). For example 399 (of https://cwe.mitre.org/data/definitions/399.html)
      # Example: [399]
      :cwes,
      # Description - A description of the vulnerability as provided by the source.
      :description,
      # Details - If available, an in-depth description of the vulnerability as provided by the source organization. Details often include information useful in understanding root cause.
      :detail,
      # Recommendation - Recommendations of how the vulnerability can be remediated or mitigated.
      :recommendation,
      # Workarounds - A bypass, usually temporary, of the vulnerability that reduces its likelihood and/or impact. Workarounds often involve changes to configuration or deployments.
      :workaround,
      # Proof of Concept - Evidence used to reproduce the vulnerability.
      :proof_of_concept,
      # Advisories - Published advisories of the vulnerability if provided.
      :advisories,
      # Created - The date and time (timestamp) when the vulnerability record was created in the vulnerability database.
      :created,
      # Published - The date and time (timestamp) when the vulnerability record was first published.
      :published,
      # Updated - The date and time (timestamp) when the vulnerability record was last updated.
      :updated,
      # Rejected - The date and time (timestamp) when the vulnerability record was rejected (if applicable).
      :rejected,
      # Credits - Individuals or organizations credited with the discovery of the vulnerability.
      :credits,
      # Tools - The tool(s) used to identify, confirm, or score the vulnerability.
      :tools,
      # Impact Analysis - An assessment of the impact and exploitability of the vulnerability.
      :analysis,
      # Affects - The components or services that are affected by the vulnerability.
      :affects,
      # Properties - Provides the ability to document properties in a name-value store. This provides flexibility to include data not officially supported in the standard without having to use additional namespaces or create extensions. Unlike key-value stores, properties support duplicate names, each potentially having different values. Property names of interest to the general public are encouraged to be registered in the [CycloneDX Property Taxonomy](https://github.com/CycloneDX/cyclonedx-property-taxonomy). Formal registration is optional.
      :properties,
      keyword_init: true
    )
      include SchemaObject

      json_name :bom_ref, "bom-ref"

      def valid? # rubocop:disable Metrics/AbcSize,Metrics/CyclomaticComplexity,Metrics/MethodLength,Metrics/PerceivedComplexity
        Validator.valid?(String, bom_ref, pattern: Pattern::REF_LINK) &&
          Validator.valid?(String, id) &&
          Validator.valid?(VulnerabilitySource, source) &&
          Validator.valid?(Array, references, items: Reference) &&
          Validator.valid?(Array, ratings, items: Rating) &&
          Validator.valid?(Array, cwes, items: [Integer, minimum: 1]) &&
          Validator.valid?(String, description) &&
          Validator.valid?(String, detail) &&
          Validator.valid?(String, recommendation) &&
          Validator.valid?(String, workaround) &&
          Validator.valid?(ProofOfConcept, proof_of_concept) &&
          Validator.valid?(Array, advisories, items: Advisory) &&
          Validator.valid?(DateTime, created) &&
          Validator.valid?(DateTime, published) &&
          Validator.valid?(DateTime, updated) &&
          Validator.valid?(DateTime, rejected) &&
          Validator.valid?(Credits, credits) &&
          Validator.valid?(Tools, tools) &&
          Validator.valid?(Analysis, analysis) &&
          Validator.valid?(Array, affects, unique: true, items: Affects) &&
          Validator.valid?(Array, properties, items: Property)
      end

      class Analysis < Struct.new(
        "Analysis",
        :state,
        :justification,
        # Response - A response to the vulnerability by the manufacturer, supplier, or project responsible for the affected component or service. More than one response is allowed. Responses are strongly encouraged for vulnerabilities where the analysis state is exploitable.
        :response,
        # Detail - Detailed description of the impact including methods used during assessment. If a vulnerability is not exploitable, this field should include specific details on why the component or service is not impacted by this vulnerability.
        :detail,
        # First Issued - The date and time (timestamp) when the analysis was first issued.
        :first_issued,
        # Last Updated - The date and time (timestamp) when the analysis was last updated.
        :last_updated,
        keyword_init: true
      )
        include SchemaObject

        def valid?
          Validator.valid?(String, state, enum: Enum::IMPACT_ANALYSIS_STATE) &&
            Validator.valid?(String, justification, enum: Enum::IMPACT_ANALYSIS_JUSTIFICATION) &&
            Validator.valid?(Array, response, items: [String, enum: Enum::RESPONSE]) &&
            Validator.valid?(String, detail) &&
            Validator.valid?(DateTime, first_issued) &&
            Validator.valid?(DateTime, last_updated)
        end

        class Affects < Struct.new(
          "Affects",
          # Reference - References a component or service by the objects bom-ref
          :ref,
          # Versions - Zero or more individual versions or range of versions.
          :versions,
          keyword_init: true
        )
          include SchemaObject

          def initialize(ref:, prop: nil)
            super
          end

          def valid?
            Validator.valid?(String, ref, pattern: Pattern::REF_LINK_OR_BOM_LINK_ELEMENT, required: true) &&
              Validator.valid?(Array, versions, items: Version)
          end
        end
      end

      class Credits < Struct.new(
        "Credits",
        # Organizations - The organizations credited with vulnerability discovery.
        :organizations,
        # Individuals - The individuals, not associated with organizations, that are credited with vulnerability discovery.
        :individuals,
        keyword_init: true
      )
        include SchemaObject

        def valid?
          Validator.valid?(Array, organizations, items: OrganizationalEntity) &&
            Validator.valid?(Array, individuals, items: OrganizationalContact)
        end
      end

      class ProofOfConcept < Struct.new(
        "ProofOfConcept",
        # Steps to Reproduce - Precise steps to reproduce the vulnerability.
        :reproduction_steps,
        # Environment - A description of the environment in which reproduction was possible.
        :environment,
        # Supporting Material - Supporting material that helps in reproducing or understanding how reproduction is possible. This may include screenshots, payloads, and PoC exploit code.
        :supporting_material,
        keyword_init: true
      )
        include SchemaObject

        def valid?
          Validator.valid?(String, reproduction_steps) &&
            Validator.valid?(String, environment) &&
            Validator.valid?(Array, supporting_material, items: Attachment)
        end
      end

      class Reference < Struct.new(
        "Reference",
        # ID - An identifier that uniquely identifies the vulnerability.
        # Examples: "CVE-2021-39182", "GHSA-35m5-8cvj-8783", "SNYK-PYTHON-ENROCRYPT-1912876"
        :id,
        # The source that published the vulnerability.
        :source,
        keyword_init: true
      )
        include SchemaObject

        def initialize(id:, source:)
          super(id: id, source: source)
        end

        def valid?
          Validator.valid?(String, id, required: true) &&
            Validator.valid?(VulnerabilitySource, source, required: true)
        end
      end
    end
  end
end
